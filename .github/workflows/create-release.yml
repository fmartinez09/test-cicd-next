name: Crear rama release, tag, y fusionar a main

on:
  push:
    branches:
      - develop  # El pipeline se ejecuta cuando hay un push a develop
    paths:
      - 'package.json'  # Solo se ejecuta si hay cambios en el archivo package.json

jobs:
  create-release-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Necesario para crear ramas y escribir cambios

    steps:
      - name: Clonar el repositorio
        uses: actions/checkout@v3

      - name: Leer la versión desde package.json
        id: get-version
        run: |
          # Leer la versión del package.json
          VERSION=$(node -p "require('./package.json').version")
          echo "La versión actual del package.json es: $VERSION"

          # Guardar la versión en una variable para el siguiente paso
          echo "release_name=release/$VERSION" >> $GITHUB_ENV

      - name: Verificar si la versión cambió
        run: |
          if [[ -z "${{ env.release_name }}" ]]; then
            echo "No se ha encontrado un cambio en la versión. El pipeline no hará nada."
            exit 0
          fi
        continue-on-error: true

      - name: Verificar y crear la rama si no existe
        run: |
          git fetch origin
          if git rev-parse --verify origin/$release_name > /dev/null 2>&1; then
            echo "La rama $release_name ya existe en el remoto."
          else
            git checkout develop
            git checkout -b $release_name
            git push -u origin $release_name
          fi
      
      - name: Crear y subir la rama release/*
        run: |
          # Fetch para asegurarse de que se tiene la información más reciente de develop
          git fetch origin develop
          
          # Cambiar a develop y crear la nueva rama release
          git checkout develop
          git checkout -b $release_name

          # Subir la nueva rama al remoto
          git push origin $release_name

      - name: Crear el tag y asociarlo con el release
        run: |
          # Crear el tag con el nombre de la versión
          git tag $VERSION

          # Subir el tag al remoto
          git push origin $VERSION

      - name: Crear el Release en GitHub
        uses: softprops/action-gh-release@v1
        with:
          files: |
            path/to/your/files/*.tar.gz  # Opcional: incluir archivos que quieras asociar con el release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fusionar la rama release/* a main
        run: |
          # Fetch para obtener la última información de main
          git fetch origin main
          
          # Cambiar a la rama main
          git checkout main
          
          # Fusionar la rama release/* a main
          git merge $release_name --no-ff -m "Fusionando la rama $release_name a main"
          
          # Subir la fusión a main
          git push origin main

      - name: Notificar la creación de la rama y el tag
        run: |
          echo "La rama $release_name fue creada exitosamente desde develop."
          echo "El tag $VERSION ha sido creado y subido."
          echo "La rama $release_name ha sido fusionada a main."
